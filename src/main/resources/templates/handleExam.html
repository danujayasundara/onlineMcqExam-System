<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor Started Exam</title>
  <link rel="stylesheet" th:href="@{../css/styles.css}">
  <style>
  	#ratio {
		font-size: 40px;
	}
  </style>
</head>
<body>
  <header>
    <div class="mainheader">
      <img src="image/logo.png" alt="Logo">
      <h1>Edueye</h1>
    </div>
  </header>
  <div class="teachermain">
    <div class="tdashboard">
      <ul>
        <li><a th:href="@{/admin-page}">Home</a></li>
        <li><a href="#" id="examsLink">Exam</a></li>
        <li><a th:href="@{/logout}">Logout</a></li>
      </ul>
    </div>
    <div class="attendancemain">
        <div class="examtime">
            <h3 id ="examNameMain"></h3>
            <div class="attleft">
                <div class="atttopleft">
                    <div class="timeleft">
                        <table id="timelefttable">
                            <tr>
                                <td id="examStatus">Exam Completed</td>
                            </tr>
                            <tr class="count-display">
                                <td><span id="ratio">0/0</span></td>
                            </tr>
                            <tr id="timerRow">
					            <th>Time Left</th>
					            <th id="timer">00:00:00</th>
					            <th>mins</th>
					        </tr>
                        </table>
                    </div>
                </div>
                <div class="attbottomleft">
                    <div class="Startedending">
                    <div id="duration" th:text="${duration}" style="display: none;"></div>
                        <table id="startendtimetable">
                            <tr>
                                <th>Exam Started Time</th>
                                <td id = "startTime"></td>
                            </tr>
                            <tr>
                                <th>Exam Ending Time</th>
                                <td id = "endTime"></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="attright">
                <div class="attstudent">
                    <table id="attendingstulist">
					    <thead>
					        <tr>
					            <th>Full Name</th>
					            <th>Status</th>
					        </tr>
					    </thead>
					    <tbody>
					        
					    </tbody>
					</table>

                </div>
                <div class="endexam">
                    <table id="endexambtn" align="right">
                        <tr>
                            <td><button id="endExamButton" >End Exam</button></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  	var userId = sessionStorage.getItem('userId');
	document.getElementById('examsLink').href = `/exams?userId=${userId}`;
	
	function getExamIdFromURL() {
	    const urlPath = window.location.pathname;
	    const pathParts = urlPath.split('/');
	    const examId = pathParts[pathParts.length - 1];
	    return examId;
	}
	
	document.addEventListener('DOMContentLoaded', function() {
	    let examId = getExamIdFromURL(); 
	    let storedTime = localStorage.getItem('currentTime_' + examId);
	
	    if (storedTime && !isNaN(parseInt(storedTime))) {
	        let timestamp = parseInt(storedTime);
	        let currentDate = new Date(timestamp);
	
	        let hours = currentDate.getHours();
	        let minutes = currentDate.getMinutes();
	        let seconds = currentDate.getSeconds();
	
	        let formattedTime = `${hours}:${minutes}:${seconds}`;
	        console.log('Formatted Time:', formattedTime);
	        document.getElementById('startTime').textContent = formattedTime;
	    } else {
	        console.error('Invalid or missing stored timestamp.');
	    }
	});
	
	document.addEventListener('DOMContentLoaded', function() {
	    let examId = getExamIdFromURL();  
	    let duration = localStorage.getItem('duration_' + examId);
	    console.log('Duration is',duration);
	
	    if (duration) {
	        let storedTime = localStorage.getItem('currentTime_' + examId);
	        if (storedTime && !isNaN(parseInt(storedTime))) {
	            let startTime = new Date(parseInt(storedTime));
	            let endTime = new Date(startTime.getTime() + duration * 60000);
	
	            console.log('End Time stored in localStorage:', endTime);
	            localStorage.setItem('endTime_' + examId, endTime);
	
	            let formattedEndTime = `${endTime.getHours()}:${endTime.getMinutes()}:${endTime.getSeconds()}`;
	            console.log('Formatted End Time:', formattedEndTime);
	
	            document.getElementById('endTime').textContent = formattedEndTime;
	        } else {
	            console.error('Invalid or missing stored start time.');
	        }
	    } else {
	        console.error('Invalid or missing stored duration.');
	    }
	});
	
	  // Timer logic teacher
    document.addEventListener('DOMContentLoaded', function() {
        const timerElement = document.getElementById('timer');
        const examId = getExamIdFromURL();
        let interval;
        let endTime;

        console.log("ID FOR TIMER", examId);
        const endExamButton = document.getElementById('endExamButton');

        function fetchRemainingTime() {
            fetch(`/getRemainingTime/${examId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Remaining Time Data:', data); // Debugging: Log the fetched remaining time data
                    const remainingSeconds = data.remainingSeconds;
                    endTime = Date.now() + remainingSeconds * 1000; // Calculate the end time
                    startTimer(remainingSeconds); // Start the timer with the fetched remaining time
                })
                .catch(error => {
                    console.error('Error fetching remaining time:', error);
                });
        }

        function startTimer(initialRemainingSeconds) {
            function updateTimer() {
                const now = Date.now();
                const remainingSeconds = Math.max(Math.floor((endTime - now) / 1000), 0);
                console.log('Remaining seconds:', remainingSeconds); // Debugging: Log remaining seconds

                if (remainingSeconds <= 0) {
                    clearInterval(interval); // Stop updating the timer if time is up
                    timerElement.textContent = '00:00:00';
                    endExamButton.click(); // Trigger end exam button
                    localStorage.removeItem(`timer_${examId}`); // Remove the timer data from localStorage
                    console.log('Timer stopped.'); // Debugging: Log timer stopped
                    return; // Exit the function to prevent further execution
                }

                const hours = Math.floor((remainingSeconds % 86400) / 3600);
                const minutes = Math.floor((remainingSeconds % 3600) / 60);
                const seconds = remainingSeconds % 60;

                timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                localStorage.setItem(`timer_${examId}`, remainingSeconds); // Store remaining time in localStorage
            }

            // Update the timer initially and then every second
            updateTimer();
            interval = setInterval(updateTimer, 1000);
        }

        // Fetch the remaining time data from the backend and start the timer
        fetchRemainingTime();

        $('#endExamButton').click(function() {
            console.log('End exam button clicked.');
            clearInterval(interval); // Stop the timer
            timerElement.textContent = '00:00:00';
            localStorage.removeItem(`timer_${examId}`); // Remove the timer data from localStorage
            endExam(examId); // Call end exam function
            
            const event = new Event('teacherExamEnded');
    		document.dispatchEvent(event);
        });

        function endExam(examId) {
            // Check if the exam has already ended
            fetch(`/hasExamEnded?examId=${examId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.result) {
                        // If the exam has already ended, do not proceed with ending the exam
                        alert('The exam has already ended.');
                    } else {
                        // Proceed with ending the exam
                        $.ajax({
                            url: '/end-exam/' + examId,
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ examId: examId }), 
                            success: function(response) {
                                console.log('AJAX success');
                                alert('Exam ended successfully!');
                                // Update the exam status
                                checkExamStatus();
                            },
                            error: function(xhr, status, error) {
                                console.error(error);
                                console.log('AJAX error');
                                alert('Failed to end exam!');
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error checking exam status:', error);
                });
        }

        function getExamIdFromURL() {
            const urlPath = window.location.pathname;
            const pathParts = urlPath.split('/');
            return pathParts[pathParts.length - 1];
        }
    });
    
	//attempting students
	document.addEventListener('DOMContentLoaded', function() {
	    const examId = getExamIdFromURL();
	    fetchAndDisplayStudents(examId); 
	    
	    function fetchAndDisplayStudents(examId) {
	        const tableBody = document.querySelector('#attendingstulist tbody');
	        fetch(`/exam/${examId}/students`)
	            .then(response => {
	                if (!response.ok) {
	                    throw new Error('Network response was not ok');
	                }
	                return response.json();
	            })
	            .then(data => {
	                console.log('Students Data:', data); 
	                tableBody.innerHTML = ''; // clear existing rows
	                
	                let completedCount = 0;
                    let totalCount = data.length;
                    
	                data.forEach(student => {
	                    const row = tableBody.insertRow();
	                    row.insertCell(0).textContent = student.fullname;
	                    const statusCell = row.insertCell(1);
	                    statusCell.textContent = student.status ? 'Completed' : 'Attending';
	                    statusCell.style.color = student.status ? 'green' : 'blue'; 
	                    
	                    if (student.status) {
                            completedCount++;
                        } 
	                });
	               
					document.getElementById('ratio').textContent = `${completedCount}/${totalCount}`;
	            })
	            .catch(error => {
	                console.error('Error fetching students:', error);
	            });
	    }
	
	    setInterval(function() {
	        fetchAndDisplayStudents(examId);
	    }, 5000); 

	    function getExamIdFromURL() {
	        const urlPath = window.location.pathname;
	        const pathParts = urlPath.split('/');
	        return pathParts[pathParts.length - 1];
	    }
	});
	
	//display exam name
	function fetchAndDisplayExamName() {
	    const examId = getExamIdFromURL();
	    fetch('/exam/' + examId)
	        .then(response => {
	            if (!response.ok) {
	                throw new Error('Network response was not ok');
	            }
	            return response.json();
	        })
	        .then(data => {
	            console.log('Exam Details:', data); 
	            const examNameElement = document.getElementById('examNameMain');
	            if (examNameElement) {
	                examNameElement.textContent = data.examName;
	            }
	        })
	        .catch(error => {
	            console.error('Error fetching exam details:', error);
	        });
	}
	
	// hide end exam button, timer
	function checkExamStatus() {
        const examId = getExamIdFromURL();
        fetch(`/hasExamEnded?examId=${examId}`)
            .then(response => response.json())
            .then(data => {
                if (data.result) {
                    document.getElementById('endExamButton').style.display = 'none';
                    document.getElementById('endExamButton').disabled = true;
                    document.getElementById('timerRow').style.display = 'none';
                    document.getElementById('examStatus').textContent = 'Exam Ended';
                }
                else {
	                document.getElementById('examStatus').textContent = 'Exam Completed';
	            }
            })
            .catch(error => {
                console.error('Error checking exam status:', error);
            });
    }
	
	document.addEventListener('DOMContentLoaded', function() {
        fetchAndDisplayExamName();
        checkExamStatus();
    });

  </script>

  <footer>
    <div class="mainfooter">
      &copy; 2024 EduEye. All rights reserved.
    </div>
  </footer>
</body>
</html>